module Blif
open System 
open ExprTypes
open GenOp
open System.Text.RegularExpressions
open AncillaHeap
open System.IO
open RCircuit

let exampleHuge = 
   "1------------------------------------------------ 1\n\
    -1----------------------------------------------- 1\n\
    --1---------------------------------------------- 1\n\
    ---1--------------------------------------------- 1\n\
    ----1-------------------------------------------- 1\n\
    -----1------------------------------------------- 1\n\
    ------1------------------------------------------ 1\n\
    -------1----------------------------------------- 1\n\
    --------1---------------------------------------- 1\n\
    ---------1--------------------------------------- 1\n\
    ----------1-------------------------------------- 1\n\
    -----------1------------------------------------- 1\n\
    ------------1------------------------------------ 1\n\
    -------------1----------------------------------- 1\n\
    --------------------0-001---1-------------------- 1\n\
    --------------------0-00-1--1-------------------- 1\n\
    --------------------0-00----11------------------- 1\n\
    --------------------0-00------11----------------- 1\n\
    -------------------10--0----1----------1--------- 1\n\
    --------------------0--0----1---------01--------- 1\n\
    --------------------0-001---------------1-------- 1\n\
    --------------------0-00-1--------------1-------- 1\n\
    --------------------0-00-----1----------1-------- 1\n\
    --------------------0-001--------------------1--- 1\n\
    --------------------0-00-1-------------------1--- 1\n\
    --------------------0-00-----1---------------1--- 1\n\
    -----------------1--0-001-----1------------------ 1\n\
    -----------------1--0-00-1----1------------------ 1\n\
    -----------------1--0-00-----11------------------ 1\n\
    -------------------00-00----1---------1---------- 1\n\
    -------------------10--0------11-------1--------- 1\n\
    -------------------1---01-1-1----------0--------- 1\n\
    -------------------1---0-11-1----------0--------- 1\n\
    -------------------1---0--1-11---------0--------- 1\n\
    -------------------1---0--1---11-------0--------- 1\n\
    -----------------------01-1-1---------00--------- 1\n\
    -----------------------0-11-1---------00--------- 1\n\
    -----------------------0--1-11--------00--------- 1\n\
    -------------------00-00--------------1-1-------- 1\n\
    -------------------10--01--------------11-------- 1\n\
    -------------------10--0-1-------------11-------- 1\n\
    -------------------10--0-----1---------11-------- 1\n\
    --------------------0--01-------------011-------- 1\n\
    --------------------0--0-1------------011-------- 1\n\
    --------------------0--0-----1--------011-------- 1\n\
    -------------------1---01-1------------01-------- 1\n\
    -------------------1---0-11------------01-------- 1\n\
    -------------------1---0--1--1---------01-------- 1\n\
    -----------------------01-1-----------001-------- 1\n\
    -----------------------0-11-----------001-------- 1\n\
    -----------------------0--1--1--------001-------- 1\n\
    -------------------00-00--------------1------1--- 1\n\
    -------------------10--01--------------1-----1--- 1\n\
    -------------------10--0-1-------------1-----1--- 1\n\
    -------------------10--0-----1---------1-----1--- 1\n\
    --------------------0--01-------------01-----1--- 1\n\
    --------------------0--0-1------------01-----1--- 1\n\
    --------------------0--0-----1--------01-----1--- 1\n\
    -------------------1---01-1------------0-----1--- 1\n\
    -------------------1---0-11------------0-----1--- 1\n\
    -------------------1---0--1--1---------0-----1--- 1\n\
    -----------------------01-1-----------00-----1--- 1\n\
    -----------------------0-11-----------00-----1--- 1\n\
    -----------------------0--1--1--------00-----1--- 1\n\
    --------------------0-001------------------1--1-- 1\n\
    --------------------0-00-1-----------------1--1-- 1\n\
    --------------------0-00-----1-------------1--1-- 1\n\
    -------------------00--0--------------11-------1- 1\n\
    -------------------0---0--1-----------10-------1- 1\n\
    -------------------00--0--------------11--------1 1\n\
    -------------------0---0--1-----------10--------1 1\n\
    -----------------1-00-00------1-------1---------- 1\n\
    -----------------1-10--01-----1--------1--------- 1\n\
    -----------------1-10--0-1----1--------1--------- 1\n\
    -----------------1-10--0-----11--------1--------- 1\n\
    -----------------1--0--01-----1-------01--------- 1\n\
    -----------------1--0--0-1----1-------01--------- 1\n\
    -----------------1--0--0-----11-------01--------- 1\n\
    -----------------1-1---01-1---1--------0--------- 1\n\
    -----------------1-1---0-11---1--------0--------- 1\n\
    -----------------1-1---0--1--11--------0--------- 1\n\
    -----------------1-----01-1---1-------00--------- 1\n\
    -----------------1-----0-11---1-------00--------- 1\n\
    -----------------1-----0--1--11-------00--------- 1\n\
    -------------------00-00--------------1----1--1-- 1\n\
    -------------------10--01--------------1---1--1-- 1\n\
    -------------------10--0-1-------------1---1--1-- 1\n\
    -------------------10--0-----1---------1---1--1-- 1\n\
    --------------------0--01-------------01---1--1-- 1\n\
    --------------------0--0-1------------01---1--1-- 1\n\
    --------------------0--0-----1--------01---1--1-- 1\n\
    -------------------1---01-1------------0---1--1-- 1\n\
    -------------------1---0-11------------0---1--1-- 1\n\
    -------------------1---0--1--1---------0---1--1-- 1\n\
    -----------------------01-1-----------00---1--1-- 1\n\
    -----------------------0-11-----------00---1--1-- 1\n\
    -----------------------0--1--1--------00---1--1-- 1\n\
    --------------------000000-1-------0--0---------- 1\n\
    --------------------0-0000-1---0---0--0---------- 1\n\
    --------------------00000--1-------00-0---------- 1\n\
    --------------------0-000--1---0---00-0---------- 1\n\
    --------------------00-000-1-------0--01--------- 1\n\
    --------------------0--000-1---0---0--01--------- 1\n\
    --------------------00-00--1-------00-01--------- 1\n\
    --------------------0--00--1---0---00-01--------- 1\n\
    ---------------------0-00011-------0--00--------- 1\n\
    -----------------------00011---0---0--00--------- 1\n\
    ---------------------0-00-11-------00-00--------- 1\n\
    -----------------------00-11---0---00-00--------- 1\n\
    --------------0----0000000-1-------0------------- 1\n\
    --------------0----00-0000-1---0---0------------- 1\n\
    --------------0----000000--1-------00------------ 1\n\
    --------------0----00-000--1---0---00------------ 1\n\
    --------------------00000001-0--------0---------- 1\n\
    --------------------0-000001-0-0------0---------- 1\n\
    --------------------00000-01-0------0-0---------- 1\n\
    --------------------0-000-01-0-0----0-0---------- 1\n\
    --------------------00-00001-0--------01--------- 1\n\
    --------------------0--00001-0-0------01--------- 1\n\
    --------------------00-00-01-0------0-01--------- 1\n\
    --------------------0--00-01-0-0----0-01--------- 1\n\
    --------------0----000000001-0------------------- 1\n\
    --------------0----00-000001-0-0----------------- 1\n\
    --------------0----000000-01-0------0------------ 1\n\
    --------------0----00-000-01-0-0----0------------ 1\n\
    ---------------1---0000000-1-------0-------1----- 1\n\
    ---------------1---00-0000-1---0---0-------1----- 1\n\
    ---------------1---000000--1-------00------1----- 1\n\
    ---------------1---00-000--1---0---00------1----- 1\n\
    ---------------1----00000001----------0-----0---- 1\n\
    ---------------1----0-000001---0------0-----0---- 1\n\
    ---------------1----00000-01--------0-0-----0---- 1\n\
    ---------------1----0-000-01---0----0-0-----0---- 1\n\
    ---------------1----00-00001----------01----0---- 1\n\
    ---------------1----0--00001---0------01----0---- 1\n\
    ---------------1----00-00-01--------0-01----0---- 1\n\
    ---------------1----0--00-01---0----0-01----0---- 1\n\
    ---------------1---000000001-0-------------1----- 1\n\
    ---------------1---00-000001-0-0-----------1----- 1\n\
    ---------------1---000000-01-0------0------1----- 1\n\
    ---------------1---00-000-01-0-0----0------1----- 1\n\
    --------------01---000000001----------------0---- 1\n\
    --------------01---00-000001---0------------0---- 1\n\
    --------------01---000000-01--------0-------0---- 1\n\
    --------------01---00-000-01---0----0-------0---- 1\n\
    ---------------1---000000001---------------10---- 1\n\
    ---------------1---00-000001---0-----------10---- 1\n\
    ---------------1---000000-01--------0------10---- 1\n\
    ---------------1---00-000-01---0----0------10---- 1\n\
    ---------------1101-00000001----------0---------- 1\n\
    ---------------1101-0-000001---0------0---------- 1\n\
    ---------------1101-00000-01--------0-0---------- 1\n\
    ---------------1101-0-000-01---0----0-0---------- 1\n\
    ---------------1-01-00000001---------10---------- 1\n\
    ---------------1-01-0-000001---0-----10---------- 1\n\
    ---------------1-01-00000-01--------010---------- 1\n\
    ---------------1-01-0-000-01---0----010---------- 1\n\
    ---------------1101-00-00001----------01--------- 1\n\
    ---------------1101-0--00001---0------01--------- 1\n\
    ---------------1101-00-00-01--------0-01--------- 1\n\
    ---------------1101-0--00-01---0----0-01--------- 1\n\
    ---------------1-01-00-00001---------101--------- 1\n\
    ---------------1-01-0--00001---0-----101--------- 1\n\
    ---------------1-01-00-00-01--------0101--------- 1\n\
    ---------------1-01-0--00-01---0----0101--------- 1\n\
    --------------0----00000-0-1----0000-----0------- 1\n\
    --------------0----00-00-0-1---00000-----0------- 1\n\
    --------------0----00000---1----00000----0------- 1\n\
    --------------0----00-00---1---000000----0------- 1\n\
    --------------0-----0000-0-1----0000--0--0------- 1\n\
    --------------0-----0-00-0-1---00000--0--0------- 1\n\
    --------------0-----0000---1----00000-0--0------- 1\n\
    --------------0-----0-00---1---000000-0--0------- 1\n\
    --------------0-----00-0-0-1----0000--01-0------- 1\n\
    --------------0-----0--0-0-1---00000--01-0------- 1\n\
    --------------0-----00-0---1----00000-01-0------- 1\n\
    --------------0-----0--0---1---000000-01-0------- 1\n\
    --------------0------0-0-011----0000--00-0------- 1\n\
    --------------0--------0-011---00000--00-0------- 1\n\
    --------------0------0-0--11----00000-00-0------- 1\n\
    --------------0--------0--11---000000-00-0------- 1\n\
    ---------------110--00000001----------0---0------ 1\n\
    ---------------110--0-000001---0------0---0------ 1\n\
    ---------------110--00000-01--------0-0---0------ 1\n\
    ---------------110--0-000-01---0----0-0---0------ 1\n\
    ---------------1-0--00000001---------10---0------ 1\n\
    ---------------1-0--0-000001---0-----10---0------ 1\n\
    ---------------1-0--00000-01--------010---0------ 1\n\
    ---------------1-0--0-000-01---0----010---0------ 1\n\
    ---------------110--00-00001----------01--0------ 1\n\
    ---------------110--0--00001---0------01--0------ 1\n\
    ---------------110--00-00-01--------0-01--0------ 1\n\
    ---------------110--0--00-01---0----0-01--0------ 1\n\
    ---------------1-0--00-00001---------101--0------ 1\n\
    ---------------1-0--0--00001---0-----101--0------ 1\n\
    ---------------1-0--00-00-01--------0101--0------ 1\n\
    ---------------1-0--0--00-01---0----0101--0------ 1\n\
    --------------0----00000-0-1----0000-------0----- 1\n\
    --------------0----00-00-0-1---00000-------0----- 1\n\
    --------------0----00000---1----00000------0----- 1\n\
    --------------0----00-00---1---000000------0----- 1\n\
    --------------0-----0000-0-1----0000--0----0----- 1\n\
    --------------0-----0-00-0-1---00000--0----0----- 1\n\
    --------------0-----0000---1----00000-0----0----- 1\n\
    --------------0-----0-00---1---000000-0----0----- 1\n\
    --------------0-----00-0-0-1----0000--01---0----- 1\n\
    --------------0-----0--0-0-1---00000--01---0----- 1\n\
    --------------0-----00-0---1----00000-01---0----- 1\n\
    --------------0-----0--0---1---000000-01---0----- 1\n\
    --------------0------0-0-011----0000--00---0----- 1\n\
    --------------0--------0-011---00000--00---0----- 1\n\
    --------------0------0-0--11----00000-00---0----- 1\n\
    --------------0--------0--11---000000-00---0----- 1\n\
    --------------01101000000001--------------------- 1\n\
    --------------0110100-000001---0----------------- 1\n\
    --------------00-1-00000-0-1----0000------------- 1\n\
    --------------00-1-00-00-0-1---00000------------- 1\n\
    --------------01101000000-01--------0------------ 1\n\
    --------------0110100-000-01---0----0------------ 1\n\
    --------------00-1-00000---1----00000------------ 1\n\
    --------------00-1-00-00---1---000000------------ 1\n\
    --------------01-01000000001---------1----------- 1\n\
    --------------01-0100-000001---0-----1----------- 1\n\
    --------------01-01000000-01--------01----------- 1\n\
    --------------01-0100-000-01---0----01----------- 1\n\
    --------------00-1--0000-0-1----0000--0---------- 1\n\
    --------------00-1--0-00-0-1---00000--0---------- 1\n\
    --------------00-1--0000---1----00000-0---------- 1\n\
    --------------00-1--0-00---1---000000-0---------- 1\n\
    --------------00-1--00-0-0-1----0000--01--------- 1\n\
    --------------00-1--0--0-0-1---00000--01--------- 1\n\
    --------------00-1--00-0---1----00000-01--------- 1\n\
    --------------00-1--0--0---1---000000-01--------- 1\n\
    --------------00-1---0-0-011----0000--00--------- 1\n\
    --------------00-1-----0-011---00000--00--------- 1\n\
    --------------00-1---0-0--11----00000-00--------- 1\n\
    --------------00-1-----0--11---000000-00--------- 1\n\
    --------------0----00000-001-0--000------0------- 1\n\
    --------------0----00-00-001-0-0000------0------- 1\n\
    --------------0----00000--01-0--000-0----0------- 1\n\
    --------------0----00-00--01-0-0000-0----0------- 1\n\
    --------------0-----0000-001-0--000---0--0------- 1\n\
    --------------0-----0-00-001-0-0000---0--0------- 1\n\
    --------------0-----0000--01-0--000-0-0--0------- 1\n\
    --------------0-----0-00--01-0-0000-0-0--0------- 1\n\
    --------------0-----00-0-001-0--000---01-0------- 1\n\
    --------------0-----0--0-001-0-0000---01-0------- 1\n\
    --------------0-----00-0--01-0--000-0-01-0------- 1\n\
    --------------0-----0--0--01-0-0000-0-01-0------- 1\n\
    --------------0110-000000001--------------0------ 1\n\
    --------------0110-00-000001---0----------0------ 1\n\
    --------------0110-000000-01--------0-----0------ 1\n\
    --------------0110-00-000-01---0----0-----0------ 1\n\
    --------------01-0-000000001---------1----0------ 1\n\
    --------------01-0-00-000001---0-----1----0------ 1\n\
    --------------01-0-000000-01--------01----0------ 1\n\
    --------------01-0-00-000-01---0----01----0------ 1\n\
    ---------------1101000000001---------------1----- 1\n\
    ---------------110100-000001---0-----------1----- 1\n\
    ---------------1101000000-01--------0------1----- 1\n\
    ---------------110100-000-01---0----0------1----- 1\n\
    ---------------1-01000000001---------1-----1----- 1\n\
    ---------------1-0100-000001---0-----1-----1----- 1\n\
    ---------------1-01000000-01--------01-----1----- 1\n\
    ---------------1-0100-000-01---0----01-----1----- 1\n\
    ---------------110-000000001--------------01----- 1\n\
    ---------------110-00-000001---0----------01----- 1\n\
    ---------------110-000000-01--------0-----01----- 1\n\
    ---------------110-00-000-01---0----0-----01----- 1\n\
    ---------------1-0-000000001---------1----01----- 1\n\
    ---------------1-0-00-000001---0-----1----01----- 1\n\
    ---------------1-0-000000-01--------01----01----- 1\n\
    ---------------1-0-00-000-01---0----01----01----- 1\n\
    --------------0----00000-001-0--000--------0----- 1\n\
    --------------0----00-00-001-0-0000--------0----- 1\n\
    --------------0----00000--01-0--000-0------0----- 1\n\
    --------------0----00-00--01-0-0000-0------0----- 1\n\
    --------------0-----0000-001-0--000---0----0----- 1\n\
    --------------0-----0-00-001-0-0000---0----0----- 1\n\
    --------------0-----0000--01-0--000-0-0----0----- 1\n\
    --------------0-----0-00--01-0-0000-0-0----0----- 1\n\
    --------------0-----00-0-001-0--000---01---0----- 1\n\
    --------------0-----0--0-001-0-0000---01---0----- 1\n\
    --------------0-----00-0--01-0--000-0-01---0----- 1\n\
    --------------0-----0--0--01-0-0000-0-01---0----- 1\n\
    ----------------1010000000-1-------0-------11---- 1\n\
    ----------------10100-0000-1---0---0-------11---- 1\n\
    ----------------101000000--1-------00------11---- 1\n\
    ----------------10100-000--1---0---00------11---- 1\n\
    -----------------010000000-1-------0-1-----11---- 1\n\
    -----------------0100-0000-1---0---0-1-----11---- 1\n\
    -----------------01000000--1-------001-----11---- 1\n\
    -----------------0100-000--1---0---001-----11---- 1\n\
    ----------------10-0000000-1-------0------011---- 1\n\
    ----------------10-00-0000-1---0---0------011---- 1\n\
    ----------------10-000000--1-------00-----011---- 1\n\
    ----------------10-00-000--1---0---00-----011---- 1\n\
    -----------------0-0000000-1-------0-1----011---- 1\n\
    -----------------0-00-0000-1---0---0-1----011---- 1\n\
    -----------------0-000000--1-------001----011---- 1\n\
    -----------------0-00-000--1---0---001----011---- 1\n\
    --------------00---00000-0-1----0000--------0---- 1\n\
    --------------00---00-00-0-1---00000--------0---- 1\n\
    --------------00---00000---1----00000-------0---- 1\n\
    --------------00---00-00---1---000000-------0---- 1\n\
    --------------00----0000-0-1----0000--0-----0---- 1\n\
    --------------00----0-00-0-1---00000--0-----0---- 1\n\
    --------------00----0000---1----00000-0-----0---- 1\n\
    --------------00----0-00---1---000000-0-----0---- 1\n\
    --------------00----00-0-0-1----0000--01----0---- 1\n\
    --------------00----0--0-0-1---00000--01----0---- 1\n\
    --------------00----00-0---1----00000-01----0---- 1\n\
    --------------00----0--0---1---000000-01----0---- 1\n\
    --------------00-----0-0-011----0000--00----0---- 1\n\
    --------------00-------0-011---00000--00----0---- 1\n\
    --------------00-----0-0--11----00000-00----0---- 1\n\
    --------------00-------0--11---000000-00----0---- 1\n\
    --------------00-1-00000-001-0--000-------------- 1\n\
    --------------00-1-00-00-001-0-0000-------------- 1\n\
    --------------00-1-00000--01-0--000-0------------ 1\n\
    --------------00-1-00-00--01-0-0000-0------------ 1\n\
    --------------000--00000-0-1----0000-0----------- 1\n\
    --------------000--00-00-0-1---00000-0----------- 1\n\
    --------------000--00000---1----000000----------- 1\n\
    --------------000--00-00---1---0000000----------- 1\n\
    --------------00-1--0000-001-0--000---0---------- 1\n\
    --------------00-1--0-00-001-0-0000---0---------- 1\n\
    --------------00-1--0000--01-0--000-0-0---------- 1\n\
    --------------00-1--0-00--01-0-0000-0-0---------- 1\n\
    --------------000---0000-0-1----0000-00---------- 1\n\
    --------------000---0-00-0-1---00000-00---------- 1\n\
    --------------000---0000---1----0000000---------- 1\n\
    --------------000---0-00---1---00000000---------- 1\n\
    --------------00-1--00-0-001-0--000---01--------- 1\n\
    --------------00-1--0--0-001-0-0000---01--------- 1\n\
    --------------00-1--00-0--01-0--000-0-01--------- 1\n\
    --------------00-1--0--0--01-0-0000-0-01--------- 1\n\
    --------------000---00-0-0-1----0000-001--------- 1\n\
    --------------000---0--0-0-1---00000-001--------- 1\n\
    --------------000---00-0---1----00000001--------- 1\n\
    --------------000---0--0---1---000000001--------- 1\n\
    --------------000----0-0-011----0000-000--------- 1\n\
    --------------000------0-011---00000-000--------- 1\n\
    --------------000----0-0--11----00000000--------- 1\n\
    --------------000------0--11---000000000--------- 1\n\
    --------------00--000000-0-1----0000------1------ 1\n\
    --------------00--000-00-0-1---00000------1------ 1\n\
    --------------00--000000---1----00000-----1------ 1\n\
    --------------00--000-00---1---000000-----1------ 1\n\
    --------------00--0-0000-0-1----0000--0---1------ 1\n\
    --------------00--0-0-00-0-1---00000--0---1------ 1\n\
    --------------00--0-0000---1----00000-0---1------ 1\n\
    --------------00--0-0-00---1---000000-0---1------ 1\n\
    --------------00--0-00-0-0-1----0000--01--1------ 1\n\
    --------------00--0-0--0-0-1---00000--01--1------ 1\n\
    --------------00--0-00-0---1----00000-01--1------ 1\n\
    --------------00--0-0--0---1---000000-01--1------ 1\n\
    --------------00--0--0-0-011----0000--00--1------ 1\n\
    --------------00--0----0-011---00000--00--1------ 1\n\
    --------------00--0--0-0--11----00000-00--1------ 1\n\
    --------------00--0----0--11---000000-00--1------ 1\n\
    ----------------101000000001-0-------------11---- 1\n\
    ----------------10100-000001-0-0-----------11---- 1\n\
    ----------------101000000-01-0------0------11---- 1\n\
    ----------------10100-000-01-0-0----0------11---- 1\n\
    -----------------01000000001-0-------1-----11---- 1\n\
    -----------------0100-000001-0-0-----1-----11---- 1\n\
    -----------------01000000-01-0------01-----11---- 1\n\
    -----------------0100-000-01-0-0----01-----11---- 1\n\
    ----------------10-000000001-0------------011---- 1\n\
    ----------------10-00-000001-0-0----------011---- 1\n\
    ----------------10-000000-01-0------0-----011---- 1\n\
    ----------------10-00-000-01-0-0----0-----011---- 1\n\
    -----------------0-000000001-0-------1----011---- 1\n\
    -----------------0-00-000001-0-0-----1----011---- 1\n\
    -----------------0-000000-01-0------01----011---- 1\n\
    -----------------0-00-000-01-0-0----01----011---- 1\n\
    --------------00---00000-001-0--000---------0---- 1\n\
    --------------00---00-00-001-0-0000---------0---- 1\n\
    --------------00---00000--01-0--000-0-------0---- 1\n\
    --------------00---00-00--01-0-0000-0-------0---- 1\n\
    --------------00----0000-001-0--000---0-----0---- 1\n\
    --------------00----0-00-001-0-0000---0-----0---- 1\n\
    --------------00----0000--01-0--000-0-0-----0---- 1\n\
    --------------00----0-00--01-0-0000-0-0-----0---- 1\n\
    --------------00----00-0-001-0--000---01----0---- 1\n\
    --------------00----0--0-001-0-0000---01----0---- 1\n\
    --------------00----00-0--01-0--000-0-01----0---- 1\n\
    --------------00----0--0--01-0-0000-0-01----0---- 1\n\
    --------------01---00000-001----000------0--0---- 1\n\
    --------------01---00-00-001---0000------0--0---- 1\n\
    --------------01---00000--01----000-0----0--0---- 1\n\
    --------------01---00-00--01---0000-0----0--0---- 1\n\
    --------------01----0000-001----000---0--0--0---- 1\n\
    --------------01----0-00-001---0000---0--0--0---- 1\n\
    --------------01----0000--01----000-0-0--0--0---- 1\n\
    --------------01----0-00--01---0000-0-0--0--0---- 1\n\
    --------------01----00-0-001----000---01-0--0---- 1\n\
    --------------01----0--0-001---0000---01-0--0---- 1\n\
    --------------01----00-0--01----000-0-01-0--0---- 1\n\
    --------------01----0--0--01---0000-0-01-0--0---- 1\n\
    --------------01---00000-001----000--------00---- 1\n\
    --------------01---00-00-001---0000--------00---- 1\n\
    --------------01---00000--01----000-0------00---- 1\n\
    --------------01---00-00--01---0000-0------00---- 1\n\
    --------------01----0000-001----000---0----00---- 1\n\
    --------------01----0-00-001---0000---0----00---- 1\n\
    --------------01----0000--01----000-0-0----00---- 1\n\
    --------------01----0-00--01---0000-0-0----00---- 1\n\
    --------------01----00-0-001----000---01---00---- 1\n\
    --------------01----0--0-001---0000---01---00---- 1\n\
    --------------01----00-0--01----000-0-01---00---- 1\n\
    --------------01----0--0--01---0000-0-01---00---- 1\n\
    --------------000--00000-001-0--000--0----------- 1\n\
    --------------000--00-00-001-0-0000--0----------- 1\n\
    --------------000--00000--01-0--000-00----------- 1\n\
    --------------000--00-00--01-0-0000-00----------- 1\n\
    --------------000---0000-001-0--000--00---------- 1\n\
    --------------000---0-00-001-0-0000--00---------- 1\n\
    --------------000---0000--01-0--000-000---------- 1\n\
    --------------000---0-00--01-0-0000-000---------- 1\n\
    --------------000---00-0-001-0--000--001--------- 1\n\
    --------------000---0--0-001-0-0000--001--------- 1\n\
    --------------000---00-0--01-0--000-0001--------- 1\n\
    --------------000---0--0--01-0-0000-0001--------- 1\n\
    --------------00--000000-001-0--000-------1------ 1\n\
    --------------00--000-00-001-0-0000-------1------ 1\n\
    --------------00--000000--01-0--000-0-----1------ 1\n\
    --------------00--000-00--01-0-0000-0-----1------ 1\n\
    --------------00--0-0000-001-0--000---0---1------ 1\n\
    --------------00--0-0-00-001-0-0000---0---1------ 1\n\
    --------------00--0-0000--01-0--000-0-0---1------ 1\n\
    --------------00--0-0-00--01-0-0000-0-0---1------ 1\n\
    --------------00--0-00-0-001-0--000---01--1------ 1\n\
    --------------00--0-0--0-001-0-0000---01--1------ 1\n\
    --------------00--0-00-0--01-0--000-0-01--1------ 1\n\
    --------------00--0-0--0--01-0-0000-0-01--1------ 1\n\
    --------------0110100000-001----000------0------- 1\n\
    --------------0110100-00-001---0000------0------- 1\n\
    --------------0110100000--01----000-0----0------- 1\n\
    --------------0110100-00--01---0000-0----0------- 1\n\
    --------------01-0100000-001----000--1---0------- 1\n\
    --------------01-0100-00-001---0000--1---0------- 1\n\
    --------------01-0100000--01----000-01---0------- 1\n\
    --------------01-0100-00--01---0000-01---0------- 1\n\
    --------------01101-0000-001----000---0--0------- 1\n\
    --------------01101-0-00-001---0000---0--0------- 1\n\
    --------------01101-0000--01----000-0-0--0------- 1\n\
    --------------01101-0-00--01---0000-0-0--0------- 1\n\
    --------------01-01-0000-001----000--10--0------- 1\n\
    --------------01-01-0-00-001---0000--10--0------- 1\n\
    --------------01-01-0000--01----000-010--0------- 1\n\
    --------------01-01-0-00--01---0000-010--0------- 1\n\
    --------------01101-00-0-001----000---01-0------- 1\n\
    --------------01101-0--0-001---0000---01-0------- 1\n\
    --------------01101-00-0--01----000-0-01-0------- 1\n\
    --------------01101-0--0--01---0000-0-01-0------- 1\n\
    --------------01-01-00-0-001----000--101-0------- 1\n\
    --------------01-01-0--0-001---0000--101-0------- 1\n\
    --------------01-01-00-0--01----000-0101-0------- 1\n\
    --------------01-01-0--0--01---0000-0101-0------- 1\n\
    --------------0110-00000-001----000------00------ 1\n\
    --------------0110-00-00-001---0000------00------ 1\n\
    --------------0110-00000--01----000-0----00------ 1\n\
    --------------0110-00-00--01---0000-0----00------ 1\n\
    --------------01-0-00000-001----000--1---00------ 1\n\
    --------------01-0-00-00-001---0000--1---00------ 1\n\
    --------------01-0-00000--01----000-01---00------ 1\n\
    --------------01-0-00-00--01---0000-01---00------ 1\n\
    --------------0110--0000-001----000---0--00------ 1\n\
    --------------0110--0-00-001---0000---0--00------ 1\n\
    --------------0110--0000--01----000-0-0--00------ 1\n\
    --------------0110--0-00--01---0000-0-0--00------ 1\n\
    --------------01-0--0000-001----000--10--00------ 1\n\
    --------------01-0--0-00-001---0000--10--00------ 1\n\
    --------------01-0--0000--01----000-010--00------ 1\n\
    --------------01-0--0-00--01---0000-010--00------ 1\n\
    --------------0110--00-0-001----000---01-00------ 1\n\
    --------------0110--0--0-001---0000---01-00------ 1\n\
    --------------0110--00-0--01----000-0-01-00------ 1\n\
    --------------0110--0--0--01---0000-0-01-00------ 1\n\
    --------------01-0--00-0-001----000--101-00------ 1\n\
    --------------01-0--0--0-001---0000--101-00------ 1\n\
    --------------01-0--00-0--01----000-0101-00------ 1\n\
    --------------01-0--0--0--01---0000-0101-00------ 1\n\
    --------------0110100000-001----000--------0----- 1\n\
    --------------0110100-00-001---0000--------0----- 1\n\
    --------------0110100000--01----000-0------0----- 1\n\
    --------------0110100-00--01---0000-0------0----- 1\n\
    --------------01-0100000-001----000--1-----0----- 1\n\
    --------------01-0100-00-001---0000--1-----0----- 1\n\
    --------------01-0100000--01----000-01-----0----- 1\n\
    --------------01-0100-00--01---0000-01-----0----- 1\n\
    --------------01101-0000-001----000---0----0----- 1\n\
    --------------01101-0-00-001---0000---0----0----- 1\n\
    --------------01101-0000--01----000-0-0----0----- 1\n\
    --------------01101-0-00--01---0000-0-0----0----- 1\n\
    --------------01-01-0000-001----000--10----0----- 1\n\
    --------------01-01-0-00-001---0000--10----0----- 1\n\
    --------------01-01-0000--01----000-010----0----- 1\n\
    --------------01-01-0-00--01---0000-010----0----- 1\n\
    --------------01101-00-0-001----000---01---0----- 1\n\
    --------------01101-0--0-001---0000---01---0----- 1\n\
    --------------01101-00-0--01----000-0-01---0----- 1\n\
    --------------01101-0--0--01---0000-0-01---0----- 1\n\
    --------------01-01-00-0-001----000--101---0----- 1\n\
    --------------01-01-0--0-001---0000--101---0----- 1\n\
    --------------01-01-00-0--01----000-0101---0----- 1\n\
    --------------01-01-0--0--01---0000-0101---0----- 1\n\
    --------------0110-00000-001----000-------00----- 1\n\
    --------------0110-00-00-001---0000-------00----- 1\n\
    --------------0110-00000--01----000-0-----00----- 1\n\
    --------------0110-00-00--01---0000-0-----00----- 1\n\
    --------------01-0-00000-001----000--1----00----- 1\n\
    --------------01-0-00-00-001---0000--1----00----- 1\n\
    --------------01-0-00000--01----000-01----00----- 1\n\
    --------------01-0-00-00--01---0000-01----00----- 1\n\
    --------------0110--0000-001----000---0---00----- 1\n\
    --------------0110--0-00-001---0000---0---00----- 1\n\
    --------------0110--0000--01----000-0-0---00----- 1\n\
    --------------0110--0-00--01---0000-0-0---00----- 1\n\
    --------------01-0--0000-001----000--10---00----- 1\n\
    --------------01-0--0-00-001---0000--10---00----- 1\n\
    --------------01-0--0000--01----000-010---00----- 1\n\
    --------------01-0--0-00--01---0000-010---00----- 1\n\
    --------------0110--00-0-001----000---01--00----- 1\n\
    --------------0110--0--0-001---0000---01--00----- 1\n\
    --------------0110--00-0--01----000-0-01--00----- 1\n\
    --------------0110--0--0--01---0000-0-01--00----- 1\n\
    --------------01-0--00-0-001----000--101--00----- 1\n\
    --------------01-0--0--0-001---0000--101--00----- 1\n\
    --------------01-0--00-0--01----000-0101--00----- 1\n\
    --------------01-0--0--0--01---0000-0101--00----- 1"


let exampleSmall = 
    "0- 1\n\
     -0 1"

let example1 = 
    "0-1 1\n\
     -00 1\n\
     11- 1"

let (|Match|_|) pattern input =
    let m = Regex.Match(input, pattern) in
    if m.Success then Some [ for g in m.Groups -> g.Value ] else None

let parseBlif (a:string) =  
    let lines = 
        a.Split ('\n')
    let getTable =
        function
        | Match "[01-]*"  result -> result.Head
        | _ -> failwith <| "invalid blif input"
    let parseLine a = 
        Seq.filter (function|('-',_)->false|_->true) (Seq.mapi (fun i x -> (x,i)) (getTable a))
    let toVar =
        function
        | ('1',n) -> BVar n
        | ('0',n) -> BNot (BVar n)
    let lineToBoolExp a = 
        BAnd (List.map toVar (Seq.toList <| parseLine a))
    let numVars = 
        (getTable(lines.[0])).Length
    let boolExps = 
        Array.map lineToBoolExp lines
    let combinedExp = BNot (BAnd (List.map BNot (Array.toList boolExps)))
    let mutable nodes = 
        List.init numVars (fun _-> RINIT) //Inputs 
    nodes <- RBOOLEXP (combinedExp,nodes.Length) :: RINIT :: nodes 
    nodes <- OUTPUT (nodes.Length-1) :: nodes
    nodes <- List.rev nodes        
    List.mapi  (fun i x -> printfn "%A : %A" i x) nodes
    nodes <- applyCleanup nodes        
    List.mapi  (fun i x -> printfn "%A : %A" i x) nodes
    let ah = new AncHeap()
    let gates, (outbits,_) = toGates (List.toArray nodes) Map.empty ah DEFAULT 
    let numBits = ah.maxUsed
    let gatesStr = sprintf "Gates:\r\n %A\r\n" gates
    let countsStr = sprintf "Number of Gates: %A\r\nNumber of bits: %A\r\nToff Count: %A\r\n" gates.Length numBits (List.filter (fun x -> match x with RTOFF _ -> true | _ -> false) gates).Length
    let log = String.Concat ["Hello"; gatesStr;countsStr] 
    //let log = String.Concat [countsStr] 
    File.WriteAllText("C:\liq\log.txt", log)
    
    let countsStr = sprintf "Number of bits: %A\r\nToffoli count: %A\r\n" numBits (List.filter (fun x -> match x with RTOFF _ -> true | _ -> false) gates).Length
    //MR List.mapi  (fun i x -> printfn "%A : %A" i x) gates
    printfn "Bits used: %A" ah.maxUsed
    let dot = nodesToDot (List.toArray nodes) 
    
    File.WriteAllText("C:\liq\log.txt", countsStr)
    File.WriteAllText("C:\liq\graph\graph.gv" ,dot)
    printfn "Gates: %A" gates.Length
        
let testBlif _ = 
    parseBlif  example1